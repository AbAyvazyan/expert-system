// ีีธึีถีฏึีซีกี ีฐีซีดีถีกีฏีกีถ ีถีตีธึีฉีกึีธีญีกีถีกีฏีธึีฉีตีกีถ ีกึีกีฃีธึีฉีตีธึีถีจ (BMR) ีฐีกีทีพีกึีฏีฅีฌีธึ ีฐีกีดีกึ (Mifflin-St Jeor)
function calculateBMR(weight, height, age) {
    // ีีฃีฟีกีฃีธึีฎีธึีด ีฅีถึ ีจีถีคีฐีกีถีธึึ ีขีกีถีกีฑึีจ, ีกีผีกีถึ ีฝีฅีผีจ ีฐีกีทีพีซ ีกีผีถีฅีฌีธึ (ีบีกึีฆีฅึีพีกีฎ ึึีซีถีกีฏ)
    // BMR = (10 * ึีกีท) + (6.25 * ีฐีกีฝีกีฏ) - (5 * ีฟีกึีซึ) + 5 (ีบีกึีฆีฅึีพีกีฎ ีฟีฒีกีดีกึีคีธึ ีขีกีถีกีฑึ)
    return (10 * weight) + (6.25 * height) - (5 * age) + 5;
}

// ีีธึีถีฏึีซีกี ึึีกีฏีกีถ ีจีถีคีฐีกีถีธึึ ีงีถีฅึีฃีซีกีตีซ ีฎีกีญีฝีจ (TDEE) ีฐีกีทีพีกึีฏีฅีฌีธึ ีฐีกีดีกึ
function calculateTDEE(bmr, activityLevel) {
    const activityFactors = {
        'sedentary': 1.2,        // ีีฝีฟีกีฏีตีกึ
        'light': 1.375,          // ินีฅีฉึ ีกีฏีฟีซีพ
        'moderate': 1.55,        // ีีกึีกีพีธึ ีกีฏีฟีซีพ
        'very': 1.725            // ีีกีฟ ีกีฏีฟีซีพ
    };
    return bmr * activityFactors[activityLevel];
}

// **ีีีีิฑิณิปีิฑิฟิฑี ีิฑีิฑิฟิฑีิณิป ิฟิฑีีีีิตีิธ/ิผีิณิปิฟิฑี**
function getExpertAdvice(weight, height, age, activity, goal, sweets, sleep) {
    const bmr = calculateBMR(weight, height, age);
    let tdee = calculateTDEE(bmr, activity);
    
    let calorieMessage = '';
    let trainingPlan = { title: '', plan: [] };
    let lifestyleAdvice = ''; // ิผึีกึีธึึีซีน ีญีธึีฐีธึึีค ึีกีฒึึีกีพีฅีถีซึีซ ึ ึีถีซ ีฐีกีดีกึ

    // --- ิฟีกีถีธีถีถีฅึีซ ิฒีกีฆีก 1: ีีกีฒึึีกีพีฅีถีซึ/ีีกีฝีฉึีธึีคีซ ิฟีกึีฃีกีพีธึีธึีด ---
    if (sweets === 'often') {
        lifestyleAdvice += `
            <p>โ๏ธ <strong>ีีถีถีคีกีตีซีถ ิถีฃีธึีทีกึีธึีด:</strong> ีีกีฒึึีกีพีฅีถีซึีซ ึ ึีกีฝีฉึีธึีคีซ ีกีดีฅีถึึีตีก ึีฃีฟีกีฃีธึีฎีธึีดีจ ีญีซีฝีฟ ีญีธีนีจีถีคีธีฟีธึีด ีง ึีกีถีฏีกึีกีฎ ึีซีฉีถีฅีฝ ีถีบีกีฟีกีฏีซ ีซึีกีฃีธึีฎีดีกีถีจ: ิฑีผีกีปีกึีฏีธึีด ีฅีถึ ีคึีกีถึ ึีฃีฟีกีฃีธึีฎีธึีดีจ ีถีพีกีฆีฅึีถีฅีฌ ีดีซีถีนึ ีทีกีขีกีฉีกีฏีกีถ ีกีผีกีพีฅีฌีกีฃีธึีตีถีจ 1-2 ีกีถีฃีกีด (cheat meal)ึ</p>
        `;
        // ิพีกีถึ ีคีฅีบึีฅึีธึีด ีถีพีกีฆีฅึีถีธึีด ีฅีถึ TDEE-ีถ, ีธึีบีฅีฝีฆีซ ีฐีกีทีพีซ ีกีผีถีฅีถึ ีฐีถีกึีกีพีธึ ีฉีฅึีฝีถีธึีดีจ
        if (goal === 'lose_weight') tdee -= 100; 

    } else if (sweets === 'moderate') {
        lifestyleAdvice += `
            <p>๐ก <strong>ีีถีถีคีกีตีซีถ ิฝีธึีฐีธึึีค:</strong> ีีฅึ ีนีกึีกีพีธึ ีฝีธีพีธึีธึีฉีตีธึีถีจ ีถีธึีดีกีฌ ีง, ีขีกีตึ ึีธึีฑีฅึ ึีธีญีกึีซีถีฅีฌ ึีกีฒึึีกีพีฅีถีซึีซ ีดีซ ีดีกีฝีจ ีดึีฃีฅึีธีพ ีฏีกีด ีดีธึีฃ ีทีธีฏีธีฌีกีคีธีพ:</p>
        `;
    } else {
         lifestyleAdvice += `
            <p>โ <strong>ีีถีถีคีกีตีซีถ ิดีซีฟีกึีฏีธึีด:</strong> ิดีธึึ ีธึีถีฅึ ีฃีฅึีกีฆีกีถึ ีฝีถีถีคีกีตีซีถ ีฏีกึีฃีกีบีกีฐีธึีฉีตีธึีถ: ีีกึีธึีถีกีฏีฅึ ีกีตีคีบีฅีฝ:</p>
        `;
    }
    
    // --- ิฟีกีถีธีถีถีฅึีซ ิฒีกีฆีก 2: ีีถีซ ิฟีกึีฃีกีพีธึีธึีด ---
    if (sleep === 'less_6') {
        lifestyleAdvice += `
            <p>๐จ <strong>ีีถีซ ิถีฃีธึีทีกึีธึีด:</strong> 6 ีชีกีดีซึ ีบีกีฏีกีฝ ึีธึีถีจ ีฏีฟึีธึีฏ ีขีกึีกีฝีกีขีกึ ีง ีกีฆีคีธึีด ีดีฏีกีถีกีตีซีถ ีพีฅึีกีฏีกีถีฃีถีดีกีถ (ีธึีจ ีฏีกึึีธึ ีง ีดีฏีกีถีกีตีซีถ ีฆีกีถีฃีพีกีฎ ีฐีกีพีกึีฅีฌีธึ ีฐีกีดีกึ) ึ ีกีญีธึีชีกีฏีซ ีฐีธึีดีธีถีถีฅึีซ ีพึีก (ีธึีจ ีญีกีถีฃีกึีธึีด ีง ึีกีท ีฏีธึึีถีฅีฌีธึีถ): ีีกึีฟีกีคีซึ ีขีกึีฑึีกึึีฅึ ึีธึีถีจ ีดีซีถีนึ 7-8 ีชีกีด:</p>
        `;
        // ีีถีซ ีบีกีฏีกีฝีซ ีคีฅีบึีธึีด ีดีฏีกีถีกีตีซีถ ีฆีกีถีฃีพีกีฎ ีฐีกีพีกึีฅีฌีธึ ีคีฅีบึีธึีด ีดีฅีฎีกึีถีธึีด ีฅีถึ ีคีฅึีซึีซีฟีจ
        if (goal === 'gain_muscle') tdee += 100;

    } else if (sleep === '7_8') {
        lifestyleAdvice += `
            <p>๐ <strong>ีีธึีถ:</strong> ีีฅึ ึีถีซ ีผีฅีชีซีดีจ ึีบีฟีซีดีกีฌ ีง (7-8 ีชีกีด):</p>
        `;
    } else {
        lifestyleAdvice += `
            <p>๐ก <strong>ีีธึีถ:</strong> 9+ ีชีกีด ึีธึีถีจ ีฌีกีพ ีง, ีขีกีตึ ีฐีกีดีธีฆีพีฅึ, ีธึ ีคีก ีนีซ ีญีกีถีฃีกึีธึีด ีฑีฅึ ึีซีฆีซีฏีกีฏีกีถ ีกีฏีฟีซีพีธึีฉีตีกีถีจ ึีฅึีฅีฏีจ:</p>
        `;
    }


    // --- ิฟีกีถีธีถีถีฅึีซ ิฒีกีฆีก 3: ิฟีกีฌีธึีซีกีฏีกีถีธึีฉีตีกีถ ึ ีีกึีฆีดีกีถ ีีฌีกีถ ---
    
    // **1. ีีกีทีซ ิฟีธึีธึีฝีฟ**
    if (goal === 'lose_weight') {
        const deficit = tdee - 500;
        calorieMessage = `ิฑีถีพีฟีกีถีฃ ึ ีฏีกีตีธึีถ ึีกีท ีฏีธึึีถีฅีฌีธึ ีฐีกีดีกึ, ีถีกีญีกีฟีฅีฝีฅึ **500 ีฏีฏีกีฌ ีคีฅึีซึีซีฟ** ึึีกีฏีกีถ: ีีฅึ ีกีผีกีปีกึีฏีพีธีฒ ึึีกีฏีกีถ ีฏีกีฌีธึีซีกีฏีกีถีธึีฉีตีธึีถีจ ีฏีกีฆีดีธึีด ีงี **${Math.round(deficit)} ีฏีฏีกีฌ**ึ`;

        trainingPlan.title = "ีีกึีบีฅึีถ ิฑีตึีฅีฌีธึ ีีกึีฆีดีกีถ ีีฌีกีถ (ีีธีฏีธึีฝี ีฏีกึีคีซีธ ึ ีนีกึีกีพีธึ ีธึีชีกีตีซีถ)";
        trainingPlan.plan = [
            "ิตึีฏีธึีทีกีขีฉีซ: ีึีชีกีตีซีถ ีีกึีฆีธึีด (ีีซีปีซีถ ีซีถีฟีฅีถีฝีซีพีธึีฉีตีธึีถ) 45 ึีธีบีฅ",
            "ิตึีฅึีทีกีขีฉีซ: ิฟีกึีคีซีธ (HIIT ีฏีกีด ิฑึีกีฃ ีีกีตีฌึ) 30 ึีธีบีฅ",
            "ีีธึีฅึีทีกีขีฉีซ: ีีกีถีฃีซีฝีฟ ีฏีกีด ีีธีฃีก/ีีฃีธึีดีถีฅึ",
            "ีีซีถีฃีทีกีขีฉีซ: ีึีชีกีตีซีถ ีีกึีฆีธึีด (ิฑีดีขีธีฒีป ีีกึีดีซีถีจ)",
            "ีึึีขีกีฉ: ิฟีกึีคีซีธ (ีีซีปีซีถ ีซีถีฟีฅีถีฝีซีพีธึีฉีตีกีถ ีพีกีฆึ/ีฐีฅีฎีกีถีซีพ) 45 ึีธีบีฅ",
            "ีีกีขีกีฉ: ิฑึีกีฃ ีีกีตีฌึ ีฏีกีด ินีฅีฉึ ิถีขีธีฝีกีถึ",
            "ิฟีซึีกีฏีซ: ีีกีถีฃีซีฝีฟ (ิฑีถีฐึีกีชีฅีทีฟ ีง ีพีฅึีกีฏีกีถีฃีถีดีกีถ ีฐีกีดีกึ)"
        ];
    } 
    
    // **2. ีีฏีกีถีกีตีซีถ ิถีกีถีฃีพีกีฎีซ ิฑีพีฅีฌีกึีธึีด**
    else if (goal === 'gain_muscle') {
        const surplus = tdee + 300;
        calorieMessage = `ีีฏีกีถีกีตีซีถ ีฆีกีถีฃีพีกีฎีซ ีกีณีซีถ ีกีปีกีฏึีฅีฌีธึ ีฐีกีดีกึ, ีถีกีญีกีฟีฅีฝีฅึ ีนีกึีกีพีธึ **300 ีฏีฏีกีฌ ีกีพีฅีฌึีธึีฏ** ึึีกีฏีกีถ: ีีฅึ ีกีผีกีปีกึีฏีพีธีฒ ึึีกีฏีกีถ ีฏีกีฌีธึีซีกีฏีกีถีธึีฉีตีธึีถีจ ีฏีกีฆีดีธึีด ีงี **${Math.round(surplus)} ีฏีฏีกีฌ**ึ`;

        trainingPlan.title = "ีีฏีกีถีกีตีซีถ ิถีกีถีฃีพีกีฎ ีีกีพีกึีฅีฌีธึ ีีฌีกีถ (ีีธีฏีธึีฝี ีฎีกีถึีธึีฉีตีธึีถ ึ ีพีฅึีกีฏีกีถีฃีถีธึีด)";
        trainingPlan.plan = [
            "ิตึีฏีธึีทีกีขีฉีซ: ีีฟึีฅึ/ีีฟีธึีซีถ ีีกึีดีซีถ (ิพีกีถึ)",
            "ิตึีฅึีทีกีขีฉีซ: ิฟีธึึีฎึ/ิตีผีฃีฌีธึีญ ีีฏีกีถีถีฅึ (Push Day)",
            "ีีธึีฅึีทีกีขีฉีซ: ีีกีถีฃีซีฝีฟ",
            "ีีซีถีฃีทีกีขีฉีซ: ีีฅีปึ/ิตึีฏีฃีฌีธึีญ ีีฏีกีถีถีฅึ (Pull Day)",
            "ีึึีขีกีฉ: ีึีฝีฅึ/ีีฅีผึีฅึ",
            "ีีกีขีกีฉ: ินีฅีฉึ ิฟีกึีคีซีธ ีฏีกีด ีีกีถีฃีซีฝีฟ",
            "ิฟีซึีกีฏีซ: ีีกีถีฃีซีฝีฟ (ิฟีกึึีธึ ีง ีดีฏีกีถีถีฅึีซ ีกีณีซ ีฐีกีดีกึ)"
        ];

    } 
    
    // **3. ีีกีทีซ ีีกีฐีบีกีถีธึีด**
    else if (goal === 'maintain') {
        calorieMessage = `ีีฅึ ีถีฅึีฏีกีตีซีฝ ึีกีทีจ ีบีกีฐีบีกีถีฅีฌีธึ ีฐีกีดีกึ ีีฅึ ีดีธีฟีกีพีธึ ึึีกีฏีกีถ ีฏีกีฌีธึีซีกีฏีกีถีธึีฉีตีธึีถีจ (TDEE) ีฏีกีฆีดีธึีด ีงี **${Math.round(tdee)} ีฏีฏีกีฌ**ึ`;

        trainingPlan.title = "ีีกีทีซ ีีกีฐีบีกีถีดีกีถ ีีฌีกีถ (ีีธีฏีธึีฝี ีฐีกีพีกีฝีกึีกีฏีทีผีธึีฉีตีธึีถ ึ ีกีผีธีฒีปีธึีฉีตีธึีถ)";
        trainingPlan.plan = [
            "ิตึีฏีธึีทีกีขีฉีซ: ีึีชีกีตีซีถ ีดีกึีฆีธึีด 45 ึีธีบีฅ",
            "ิตึีฅึีทีกีขีฉีซ: ิฟีกึีคีซีธ/ิดีซีดีกึีฏีธึีถีธึีฉีตีธึีถ 30 ึีธีบีฅ",
            "ีีธึีฅึีทีกีขีฉีซ: ีีกีถีฃีซีฝีฟ",
            "ีีซีถีฃีทีกีขีฉีซ: ิฑีดีขีธีฒีป ีีกึีดีถีซ ีีกึีฆีธึีด",
            "ีึึีขีกีฉ: ิถีขีธีฝีกีถึ ีฏีกีด ีีบีธึีฟีกีตีซีถ ีีธีขีขีซ",
            "ีีกีขีกีฉ: ิฑีฏีฟีซีพ ีีกีถีฃีซีฝีฟ (ึึีซีถีกีฏี ีฅึีฏีกึ ึีกีตีฌึ)",
            "ิฟีซึีกีฏีซ: ีีกีถีฃีซีฝีฟ"
        ];
    }
    
    // ีีฅึีกีคีกึีฑีถีธึีด ีฅีถึ ีขีธีฌีธึ ีกึีคีตีธึีถึีถีฅึีจ
    return { calorieMessage, trainingPlan, lifestyleAdvice };
}

// --- ิปึีกีคีกึีฑีธึีฉีตีธึีถีถีฅึีซ ีีทีกีฏีซีน ึ ิฑึีคีตีธึีถึีถีฅึีซ ีีธึึีกีคึีธึีด ---
document.getElementById('fitnessForm').addEventListener('submit', function(event) {
    event.preventDefault(); // ิฟีกีถีญีธึีด ีง ีฑึีซ ีฝีฟีกีถีคีกึีฟ ีถีฅึีฏีกีตีกึีธึีดีจ

    // 1. ีีฟีกีถีธึีด ีฅีถึ ึีฃีฟีกีฟีซึีธีป ีดีธึีฟึีฅึีจ
    const height = parseFloat(document.getElementById('height').value);
    const weight = parseFloat(document.getElementById('weight').value);
    const age = parseFloat(document.getElementById('age').value);
    const activity = document.getElementById('activity').value;
    const goal = document.getElementById('goal').value;
    const sweets = document.getElementById('sweets').value;
    const sleep = document.getElementById('sleep').value;

    // 2. ิณีธึีฎีกึีฏีธึีด ีฅีถึ ีีธึีฑีกีฃีซีฟีกีฏีกีถ ีีกีดีกีฏีกึีฃีซ ีฌีธีฃีซีฏีกีถ
    const advice = getExpertAdvice(weight, height, age, activity, goal, sweets, sleep);
    
    // ีีกีทีพีกึีฏีธึีด ีฅีถึ TDEE-ีถ ีถีธึีซึี ึีธึึีกีคึีดีกีถ ีฐีกีดีกึ
    const bmr = calculateBMR(weight, height, age);
    const tdee_calculated = calculateTDEE(bmr, activity);

    // 3. ีีธึึีกีคึีธึีด ีฅีถึ ีกึีคีตีธึีถึีถีฅึีจ
    const resultArea = document.getElementById('result');
    const calorieDisplay = document.getElementById('calorieDisplay');
    const planDisplay = document.getElementById('planDisplay');
    const adviceDisplay = document.getElementById('adviceDisplay');

    // ีีธึึีกีคึีธึีด ีฅีถึ ิฟีกีฌีธึีซีกีฏีกีถีธึีฉีตีกีถ ิฝีธึีฐีธึึีคีจ
    calorieDisplay.innerHTML = `
        <h3>๐ฏ ิฟีกีฌีธึีซีกีฏีกีถีธึีฉีตีกีถ ิฑีผีกีปีกึีฏ</h3>
        <p>ีีฅึ TDEE-ีถ (ีึีกีฏีกีถ ิธีถีคีฐีกีถีธึึ ิทีถีฅึีฃีซีกีตีซ ิพีกีญีฝีจ) ีดีธีฟีกีพีธึีกีบีฅีฝ ีฏีกีฆีดีธึีด ีง **${Math.round(tdee_calculated)} ีฏีฏีกีฌ**ึ ${advice.calorieMessage}</p>
    `;

    // ีีธึึีกีคึีธึีด ีฅีถึ ีีกึีฆีดีกีถ ีีฌีกีถีจ
    let planHTML = `<h3>๐๏ธ ${advice.trainingPlan.title}</h3><ul>`;
    advice.trainingPlan.plan.forEach(dayPlan => {
        // ิธีฝีฟ ีฏีกีถีธีถีซี ีจีถีคีฃีฎีธึีด ีฅีถึ ีฐีกีถีฃีฝีฟีซ ึึีฅึีจ
        if (dayPlan.includes('ีีกีถีฃีซีฝีฟ')) {
             planHTML += `<li style="color: #d9534f; font-weight: bold;">${dayPlan}</li>`;
        } else {
             planHTML += `<li>${dayPlan}</li>`;
        }
    });
    planHTML += '</ul>';
    planDisplay.innerHTML = planHTML;
    
    // ีีธึึีกีคึีธึีด ีฅีถึ ิฟีฅีถีฝีกีฏีฅึีบีซ ิผึีกึีธึึีซีน ิฝีธึีฐีธึึีคีจ
    adviceDisplay.innerHTML = `<h3>๐ฑ ิฟีฅีถีฝีกีฏีฅึีบีซ ิฝีธึีฐีธึึีคีถีฅึ (ิธีฝีฟ ีีฅึ ีบีกีฟีกีฝีญีกีถีถีฅึีซ)</h3>${advice.lifestyleAdvice}`;


    // ีีธึีตึ ีฅีถึ ีฟีกีฌีซีฝ ีกึีคีตีธึีถึีถีฅึีซ ีฐีกีฟีพีกีฎีจ
    resultArea.classList.remove('hidden');

    // ินีฅึีฉีธึีด ีฅีถึ ีดีซีถีนึ ีกึีคีตีธึีถึีถีฅึีซ ีฐีกีฟีพีกีฎีจ
    resultArea.scrollIntoView({ behavior: 'smooth' });
});